{% extends "layout.html" %}

{% block title %}Edit Media - Admin Dashboard - MediaShare{% endblock %}

{% block head_extra %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
{% endblock %}

{% block content %}
<div class="flex items-start justify-center bg-neutral-50 p-4">
    <div class="auth-form-wrapper w-full" style="max-width: 900px;">
        <div class="card">
            <div class="card-header">
                <h2>Edit Media</h2>
                <p class="text-secondary" style="margin-bottom:0;">Update media information and settings</p>
            </div>

            <div class="card-body">
                <form id="mediaEditForm" method="POST" action="{{ url_for('admin.media_edit', media_id=media.id) }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />

                    <!-- Two-Column Layout: Form Fields + Thumbnail -->
                    <div class="flex gap-4 mb-4">
                        <!-- Left Column: Form Fields -->
                        <div class="flex-1">
                            <!-- Action Buttons -->
                            <div class="flex justify-left gap-2 mb-2">
                                <button type="button" id="pullImdbBtn"
                                    data-url="{{ url_for('admin.pull_imdb', media_id=media.id) }}" class="btn"
                                    aria-label="Pull from IMDB">Pull from IMDB</button>
                                <button type="submit" class="btn btn-big">Update database</button>
                                <a href="{{ url_for('admin.media', q=request.args.get('q'), sort=request.args.get('sort'), direction=request.args.get('direction'), genre_id=request.args.get('genre_id')) }}"
                                    class="btn">Back</a>
                            </div>

                            <!-- Basic Information -->
                            <div class="mb-2">
                                <div class="toolbar-row mt-0 mb-4">
                                    <div class="form-group">
                                        <label class="form-label" for="title">
                                            Title <span class="required-indicator">*</span>
                                            <input type="text" id="title" name="title" class="form-input w-100"
                                                value="{{ media.title }}" required></label>
                                    </div>
                                    <div class="form-group ml-4">
                                        <label class="form-label" for="imdb_id">IMDB ID
                                            <input type="text" id="imdb_id" name="imdb_id" class="form-input w-030"
                                                value="{{ media.imdb_id or '' }}" placeholder="Not in DB"></label>
                                    </div>
                                </div>
                                <div class="form-group mb-1">
                                    <label class="form-label" for="description">Description
                                        <textarea id="description" name="description" class="form-input mb-0"
                                            rows="5" style="max-width: calc(100%);">{{ media.description or '' }}</textarea></label>
                                </div>

                                <div class="toolbar-row mt-1 mb-2">
                                    <div class="form-group">
                                        <label class="form-label">Release Date</label>
                                        <input type="date" id="release_date" name="release_date" class="form-input w-050"
                                            value="{{ media.release_date.strftime('%Y-%m-%d') if media.release_date else '' }}">
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label ml-2">Type <span class="required-indicator">*</span></label>
                                        <select id="media_type_id" name="media_type_id" class="form-input w-070" required>
                                            <option value="">-- Select Media Type --</option>
                                            {% for media_type in media_types %}
                                            <option value="{{ media_type.id }}" {% if media.media_type_id==media_type.id
                                                %}selected{% endif %}>
                                                {{ media_type.name }}{% if media_type.code %} ({{ media_type.code }}){%
                                                endif %}
                                            </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>

                                <div class="toolbar-row mt-0 mb-4">
                                    <div class="form-group ml-0 mt-0">
                                        <input type="hidden" id="imdb_genres" name="imdb_genres"
                                            value="{{ media.genres|join(', ', attribute='genre.name') or media.genre or '' }}">
                                        <div id="imdb_genres_chips" aria-label="Genres list" class="ml-0 mt-0"
                                            style="display:flex;flex-wrap:wrap;gap:4px;margin-top:2px;"></div>
                                        <input type="hidden" id="imdb_directors" name="imdb_directors"
                                            value="">
                                        <input type="hidden" id="imdb_cast" name="imdb_cast"
                                            value="">
                                        <input type="hidden" id="thumbnail_path" name="thumbnail_path"
                                            value="{{ media.thumbnail_path or '' }}">
                                        <select id="genre_add_select" class="form-input w-070">
                                            <option value="">Add Genre</option>
                                            {% for g in genres_all %}
                                            <option value="{{ g.name }}">{{ g.name }}</option>
                                            {% endfor %}
                                        </select>
                                        <a href="{{ url_for('admin.genre_management', media_id=media.id) }}" class="btn">Manage
                                            Genres</a>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Right Column: Thumbnail -->
                        <div style="width: 266px;">
                            <div class="border border-light rounded-lg p-4 bg-neutral-50 flex items-center justify-center" style="height: 338px;">
                                {% if media.thumbnail_path %}
                                {% set tp = media.thumbnail_path %}
                                {% set lower = tp|lower %}
                                {% if lower[:4] == 'http' %}
                                    {% set thumb_src = tp %}
                                {% elif tp[0] == '/' %}
                                    {% set thumb_src = tp %}
                                {% elif 'static/' in tp %}
                                    {% set thumb_src = url_for('static', filename=tp|replace('static/', '', 1)) %}
                                {% elif lower[:8] == 'uploads/' %}
                                    {% set thumb_src = url_for('static', filename=tp) %}
                                {% else %}
                                    {% set thumb_src = url_for('static', filename='uploads/thumbnails/' ~ tp) %}
                                {% endif %}
                                <img src="{{ thumb_src }}"
                                    alt="{{ media.title }} thumbnail"
                                    class="rounded-lg"
                                    style="max-width: 264px; max-height: 336px; width: auto; height: auto; object-fit: contain;">
                                {% else %}
                                <p class="text-secondary text-center text-sm">No thumbnail available</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                        <div class="toolbar-row mt-0 mb-4">
                            <div class="form-group ml-0 mt-0">
                                <label class="form-label">Director(s)</label>
                                {% set director_names = [] %}
                                {% for media_director in media.media_directors %}
                                {% if media_director.director and media_director.director.name %}
                                {% set _ = director_names.append(media_director.director.name) %}
                                {% endif %}
                                {% endfor %}
                                {% if director_names %}
                                <span style="color:#374151;font-size:14px;">{{ director_names|join(', ') }}</span>
                                {% else %}
                                <span style="color:#6b7280;font-size:14px;">No directors in database</span>
                                {% endif %}
                            </div>

                            <div class="form-group ml-0 mt-0">
                                <label class="form-label">Cast</label>
                                {% set performer_names = [] %}
                                {% for media_performer in media.media_performers %}
                                {% if media_performer.performer and media_performer.performer.name %}
                                {% set _ = performer_names.append(media_performer.performer.name) %}
                                {% endif %}
                                {% endfor %}
                                {% if performer_names %}
                                <span style="color:#374151;font-size:14px;">{{ performer_names|join(', ') }}</span>
                                {% else %}
                                <span style="color:#6b7280;font-size:14px;">No cast in database</span>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Settings -->
                        <div class="mb-2">

                            <div class="toolbar-row mr-0 mt-1">
                                <div class="form-group mr-0">
                                    <label class="form-label" for="avg_rating">Rating</label>
                                    <input type="number" id="avg_rating" name="avg_rating"
                                        class="form-input read-only w-015" step="1" min="0" max="100"
                                        value="{{ media.user_rating_100 if media.user_rating_100 is not none else '' }}"
                                        readonly>
                                    <label class="form-label mr-0" for="avg_rating_b mr-0"> based on avg of</label>
                                </div>
                                <div class="form-group ml-0 mr-0">
                                    <label class="form-label ml-0">IMDB Rating</label>
                                    <input type="number" id="imdb_rating" name="imdb_rating"
                                        class="form-input read-only w-015" step="1" min="0" max="100"
                                        value="{{ media.imdb_rating|int if media.imdb_rating is not none else '' }}"
                                        readonly>
                                    <label class="form-label mr-0" for="imdb_rating_b">+</label>
                                </div>
                                <div class="form-group ml-0">
                                    <label class="form-label ml-0">MediaShare Rating</label>
                                    <input type="number" id="user_score" name="user_score" class="form-input w-015"
                                        step="1" min="0" max="100" value="{{ media.user_score }}">
                                </div>
                            </div>

                            <div class="toolbar-row">
                            </div>
                        </div>

                        <!-- Settings -->
                        <div class="mb-2">
                            <h3>Settings</h3>
                            <div class="toolbar-row">
                                <div class="form-group">
                                    <label class="form-label">
                                        <input type="checkbox" name="is_featured" {% if media.is_featured %}checked{%
                                            endif %}>
                                        Featured (shown on "features")
                                    </label>
                                </div>
                            </div>

                            <div class="toolbar-row">
                                <div class="form-check-group">
                                    <label class="form-label">
                                        <input type="checkbox" name="adult" {% if media.adult %}checked{% endif %}>
                                        Adult content
                                    </label>
                                </div>

                                <div class="form-check-group ml-4">
                                    <label class="form-label">
                                        <input type="number" id="min_age" name="min_age" class="form-input w-020"
                                            min="0" max="21" value="{{ media.min_age or 0 }}">
                                        Minimum Age
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- File Information (Read-only) -->
                        <div class="mb-2">
                            <h3>File Information</h3>

                            <div class="toolbar-row">
                                <div class="form-group">
                                    <label class="form-label">Original Filename</label>
                                    <input type="text" class="form-input read-only"
                                        value="{{ media.filename_original }}" readonly>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">File Size</label>
                                    <input type="text" class="form-input read-only"
                                        value="{{ '%.2f MB'|format(media.file_size_bytes / (1024 * 1024)) if media.file_size_bytes else 'N/A' }}"
                                        readonly>
                                </div>
                            </div>

                            <div class="toolbar-row">
                                <div class="form-group">
                                    <label class="form-label">Created</label>
                                    <input type="text" class="form-input read-only"
                                        value="{{ media.created_at.strftime('%Y-%m-%d %H:%M:%S') if media.created_at else 'N/A' }}"
                                        readonly>
                                </div>
                            </div>
                        </div>

                </form>
            </div>

            <div class="card-footer text-center">
                <p class="text-sm text-secondary">
                    <a href="{{ url_for('admin.media', q=request.args.get('q'), sort=request.args.get('sort'), direction=request.args.get('direction'), genre_id=request.args.get('genre_id')) }}"
                        class="text-light-blue hover:text-dark-blue font-medium">
                        ← Back to Media Management
                    </a>
                </p>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const imdbBtn = document.getElementById('pullImdbBtn');
        const imdbInput = document.getElementById('imdb_rating');

        function getCsrfToken() {
            const input = document.querySelector('input[name="csrf_token"]');
            if (input && input.value) return input.value;
            const m = document.cookie && document.cookie.match(/(?:^|; )csrf_token=([^;]+)/);
            return m ? decodeURIComponent(m[1]) : '';
        }

        // Genres (chips) helpers
        const genresHiddenInput = document.getElementById('imdb_genres');
        const genresChips = document.getElementById('imdb_genres_chips');

        function parseGenres(str) {
            if (!str) return [];
            return str.split(',').map(s => s.trim()).filter(Boolean);
        }

        function renderGenreChips(arr) {
            if (!genresChips) return;
            genresChips.innerHTML = '';

            // Add "Genres" label first
            const label = document.createElement('span');
            label.textContent = 'Genres';
            label.className = '';
            label.style.display = 'flex';
            label.style.alignmentBaseline = 'middle';
            label.style.alignItems = 'center';
            label.style.fontSize = '14pt';
            label.style.fontWeight = '600';
            label.style.marginRight = '2px';
            genresChips.appendChild(label);

            const unique = Array.from(new Set(arr));
            if (unique.length === 0) {
                const span = document.createElement('span');
                span.textContent = 'No genres';
                span.style.color = '#6b7280';
                span.className = 'mt-0';
                span.style.fontSize = '12px';
                genresChips.appendChild(span);
                return;
            }
            unique.forEach((g, idx) => {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.textContent = g;
                btn.setAttribute('aria-label', 'Remove ' + g);
                btn.className = 'genre-chip';
                btn.addEventListener('click', function () {
                    const next = unique.filter((_, i) => i !== idx);
                    setGenresArray(next);
                });
                const hoverIcon = document.createElement('span');
                hoverIcon.textContent = '✖';
                hoverIcon.className = 'hover-icon';
                btn.appendChild(hoverIcon);
                genresChips.appendChild(btn);
            });
        }

        function setGenresArray(arr) {
            if (!genresHiddenInput) return;
            const unique = Array.from(new Set(arr.filter(Boolean)));
            genresHiddenInput.value = unique.join(', ');
            renderGenreChips(unique);
        }

        function syncGenresUIFromHidden() {
            if (!genresHiddenInput) return;
            setGenresArray(parseGenres(genresHiddenInput.value || ''));
        }

        // Update director display in the form
        function updateDirectorDisplay(directorsStr) {
            try {
                // Find the director label first, then get its sibling div
                const directorLabel = Array.from(document.querySelectorAll('.form-label')).find(label =>
                    label.textContent.trim() === 'Director(s)'
                );
                if (!directorLabel) {
                    console.error('Could not find Director(s) label');
                    return;
                }
                
                // Get the next sibling div which contains the director display
                const directorContainer = directorLabel.nextElementSibling;
                if (!directorContainer) {
                    console.error('Could not find director display container');
                    return;
                }

                if (directorsStr && directorsStr.trim()) {
                    // Update with director names
                    directorContainer.innerHTML = `<span style="color:#374151;font-size:14px;">${directorsStr}</span>`;
                } else {
                    // Show "No directors" message
                    directorContainer.innerHTML = '<span style="color:#6b7280;font-size:14px;">No directors in database</span>';
                }
            } catch (error) {
                console.error('Error updating director display:', error);
            }
        }

        // Update cast display in the form
        function updateCastDisplay(castStr) {
            try {
                // Find the cast label first, then get its sibling div
                const castLabel = Array.from(document.querySelectorAll('.form-label')).find(label =>
                    label.textContent.trim() === 'Cast'
                );
                if (!castLabel) {
                    console.error('Could not find Cast label');
                    return;
                }
                
                // Get the next sibling div which contains the cast display
                const castContainer = castLabel.nextElementSibling;
                if (!castContainer) {
                    console.error('Could not find cast display container');
                    return;
                }

                if (castStr && castStr.trim()) {
                    // Update with cast names
                    castContainer.innerHTML = `<span style="color:#374151;font-size:14px;">${castStr}</span>`;
                } else {
                    // Show "No cast" message
                    castContainer.innerHTML = '<span style="color:#6b7280;font-size:14px;">No cast in database</span>';
                }
            } catch (error) {
                console.error('Error updating cast display:', error);
            }
        }

        async function doFetch(btn, input, source) {
            if (!btn || !input) return;
            const url = btn.getAttribute('data-url');
            if (!url) return;

            // Store original button text for restoration
            const originalText = btn.textContent;
            btn.setAttribute('disabled', 'disabled');
            btn.textContent = 'Searching...';

            try {
                const res = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCsrfToken(),
                        'X-CSRF-Token': getCsrfToken()
                    },
                    body: JSON.stringify({})
                });
                const data = await res.json().catch(() => ({}));
                if (!res.ok || !data.success) throw new Error(data.error || ('HTTP ' + res.status));

                // Handle multiple results scenario
                if (data.multiple_results === true && data.redirect_url) {
                    // Show feedback before redirecting
                    btn.textContent = `Found ${data.count || 'multiple'} results - Redirecting...`;

                    // Brief delay to show feedback before redirect
                    setTimeout(() => {
                        window.location.href = data.redirect_url;
                    }, 500);
                    return;
                }

                // Populate fields from API response (single result)
                const d = (data && data.data) ? data.data : {};

                // IMDb ID
                try {
                    const imdbIdEl = document.getElementById('imdb_id');
                    if (imdbIdEl && (data.imdb_id || d.imdb_id)) {
                        imdbIdEl.value = (data.imdb_id || d.imdb_id || '').toString();
                    }
                } catch (_) { }

                // Title
                try {
                    const titleEl = document.getElementById('title');
                    if (titleEl && d.title) {
                        titleEl.value = d.title.toString();
                    }
                } catch (_) { }

                // Description
                try {
                    const descEl = document.getElementById('description');
                    if (descEl && d.description) {
                        descEl.value = d.description.toString();
                    }
                } catch (_) { }

                // Genres (display-only, populated from IMDb)
                try {
                    const genresEl = document.getElementById('imdb_genres');
                    if (genresEl) {
                        let g = '';
                        const dg = d.genres;
                        if (Array.isArray(dg)) {
                            g = dg.join(', ');
                        } else if (dg && typeof dg === 'object' && Array.isArray(dg.results)) {
                            g = dg.results.map(x => (x && (x.name || x.title)) ? (x.name || x.title) : '').filter(Boolean).join(', ');
                        } else if (dg) {
                            g = String(dg);
                        }
                        genresEl.value = g;
                        try { syncGenresUIFromHidden(); } catch (_e) { }
                    }
                } catch (_) { }

                // Directors (display-only, populated from IMDb)
                try {
                    const directorsEl = document.getElementById('imdb_directors');
                    if (directorsEl && d.directors) {
                        let directorsStr = '';
                        if (Array.isArray(d.directors)) {
                            directorsStr = d.directors.join(', ');
                        } else if (typeof d.directors === 'string') {
                            directorsStr = d.directors;
                        }
                        directorsEl.value = directorsStr;
                        // Update the director display in the form
                        updateDirectorDisplay(directorsStr);
                    }
                } catch (_) { }

                // Cast (display-only, populated from IMDb) - Sonnet 4.5 | 2025-10-04
                try {
                    const castEl = document.getElementById('imdb_cast');
                    if (castEl && (d.cast || d.actors || d.performers)) {
                        let castStr = '';
                        const castData = d.cast || d.actors || d.performers;
                        if (Array.isArray(castData)) {
                            // Extract names from array of objects or strings
                            castStr = castData.map(item => {
                                if (typeof item === 'string') return item;
                                if (typeof item === 'object' && item.name) return item.name;
                                return '';
                            }).filter(Boolean).join(', ');
                        } else if (typeof castData === 'string') {
                            castStr = castData;
                        }
                        castEl.value = castStr;
                        // Update the cast display in the form
                        updateCastDisplay(castStr);
                    }
                } catch (_) { }

                // Poster/Thumbnail URL - Modified by Sonnet 4.5 | 2025-10-04
                try {
                    if (d.poster) {
                        const thumbnailContainer = document.querySelector('.border.border-light.rounded-lg');
                        if (thumbnailContainer) {
                            thumbnailContainer.innerHTML = `<img src="${d.poster}" alt="Thumbnail" class="rounded-lg" style="max-width: 246px; max-height: 280px; width: auto; height: auto; object-fit: contain;">`;
                        }
                        // Update hidden field for form submission
                        const thumbnailPathEl = document.getElementById('thumbnail_path');
                        if (thumbnailPathEl) {
                            thumbnailPathEl.value = d.poster;
                        }
                    }
                } catch (_) { }

                // Release date (YYYY-MM-DD)
                try {
                    const rdEl = document.getElementById('release_date');
                    if (rdEl && d.release_date) {
                        rdEl.value = String(d.release_date).slice(0, 10);
                    }
                } catch (_) { }

                // Adult flag
                try {
                    const adultEl = document.querySelector('input[name="adult"]');
                    if (adultEl && typeof d.is_adult === 'boolean') {
                        adultEl.checked = !!d.is_adult;
                    }
                } catch (_) { }

                // IMDb rating (0-100 normalized)
                const val = (data.rating_rounded_1dp != null ? Number(data.rating_rounded_1dp)
                    : (data.rating_rounded != null ? Number(data.rating_rounded)
                        : (data.rating != null ? Math.round(Number(data.rating)) : null)));
                if (val != null && !Number.isNaN(val)) {
                    input.value = val;
                } else {
                    input.value = ''; // clear stale value
                }
                // Update average rating UI after IMDb rating change
                try { if (window.updateAvgRatingUI) window.updateAvgRatingUI(); } catch (_) { }
            } catch (err) {
                alert((source || 'Fetch') + ' failed: ' + err.message);
            } finally {
                btn.removeAttribute('disabled');
                btn.textContent = originalText;
            }
        }

        if (imdbBtn) {
            imdbBtn.addEventListener('click', function (e) {
                e.preventDefault();
                doFetch(imdbBtn, imdbInput, 'IMDB fetch');
            });
        }

        // Initialize genre chips from hidden input on load
        try { syncGenresUIFromHidden(); } catch (_) { }

        // Check for sessionStorage data from IMDb selection page
        function populateFormFromSessionStorage() {
            try {
                const imdbData = sessionStorage.getItem('imdb_selection_data');
                const timestamp = sessionStorage.getItem('imdb_selection_timestamp');

                // Check if we have data and it's not too old (10 minutes)
                if (imdbData && timestamp) {
                    const now = Date.now();
                    const dataAge = now - parseInt(timestamp, 10);
                    const mins = 60
                    const maxAge = mins * 60 * 1000;

                    if (dataAge < maxAge) {
                        const parsedData = JSON.parse(imdbData);

                        // CRITICAL: Validate that the stored media_id matches the current media being edited
                        // This prevents stale IMDb data from populating the wrong media item's form
                        const currentMediaId = {{ media.id }};
                    if (parsedData.media_id !== currentMediaId) {
                        console.log('IMDb data is for different media item (stored:', parsedData.media_id, ', current:', currentMediaId, ') - clearing stale data');
                        sessionStorage.removeItem('imdb_selection_data');
                        sessionStorage.removeItem('imdb_selection_timestamp');
                        return; // Exit early without populating
                    }

                    // Populate form fields with IMDb data
                    const d = parsedData.data || {};

                    // IMDb ID
                    const imdbIdEl = document.getElementById('imdb_id');
                    if (imdbIdEl && parsedData.imdb_id) {
                        imdbIdEl.value = parsedData.imdb_id;
                    }

                    // Title
                    const titleEl = document.getElementById('title');
                    if (titleEl && d.title) {
                        titleEl.value = d.title;
                    }

                    // Description
                    const descEl = document.getElementById('description');
                    if (descEl && d.description) {
                        descEl.value = d.description;
                    }

                    // Genres
                    const genresEl = document.getElementById('imdb_genres');
                    if (genresEl) {
                        let g = '';
                        const dg = d.genres;
                        if (Array.isArray(dg)) {
                            g = dg.join(', ');
                        } else if (dg && typeof dg === 'object' && Array.isArray(dg.results)) {
                            g = dg.results.map(x => (x && (x.name || x.title)) ? (x.name || x.title) : '').filter(Boolean).join(', ');
                        } else if (dg) {
                            g = String(dg);
                        }
                        genresEl.value = g;
                        syncGenresUIFromHidden();
                    }

                    // Directors
                    const directorsEl = document.getElementById('imdb_directors');
                    console.log('[DEBUG] Directors from sessionStorage:', d ? d.directors : 'no d object');
                    if (directorsEl && d && d.directors) {
                        let directorsStr = '';
                        const directors = d.directors;
                        if (Array.isArray(directors)) {
                            directorsStr = directors.join(', ');
                        } else if (typeof directors === 'string') {
                            directorsStr = directors;
                        }
                        console.log('[DEBUG] Setting directors value:', directorsStr);
                        directorsEl.value = directorsStr;
                        // Update the director display in the form
                        console.log('[DEBUG] Calling updateDirectorDisplay with:', directorsStr);
                        updateDirectorDisplay(directorsStr);
                    } else {
                        console.log('[DEBUG] Directors not populated - directorsEl:', !!directorsEl, 'd:', !!d, 'd.directors:', d ? d.directors : 'N/A');
                    }

                    // Cast - Sonnet 4.5 | 2025-10-04
                    const castEl = document.getElementById('imdb_cast');
                    console.log('[DEBUG] Cast from sessionStorage:', d ? (d.cast || d.actors || d.performers) : 'no d object');
                    if (castEl && d && (d.cast || d.actors || d.performers)) {
                        let castStr = '';
                        const cast = d.cast || d.actors || d.performers;
                        if (Array.isArray(cast)) {
                            // Extract names from array of objects or strings
                            castStr = cast.map(item => {
                                if (typeof item === 'string') return item;
                                if (typeof item === 'object' && item.name) return item.name;
                                return '';
                            }).filter(Boolean).join(', ');
                        } else if (typeof cast === 'string') {
                            castStr = cast;
                        }
                        console.log('[DEBUG] Setting cast value:', castStr);
                        castEl.value = castStr;
                        // Update the cast display in the form
                        console.log('[DEBUG] Calling updateCastDisplay with:', castStr);
                        updateCastDisplay(castStr);
                    } else {
                        console.log('[DEBUG] Cast not populated - castEl:', !!castEl, 'd:', !!d, 'd.cast:', d ? (d.cast || d.actors || d.performers) : 'N/A');
                    }

                    // Poster/Thumbnail URL - Sonnet 4.5 | 2025-10-04
                    try {
                        if (d.poster) {
                            const thumbnailContainer = document.querySelector('.border.border-light.rounded-lg');
                            if (thumbnailContainer) {
                                thumbnailContainer.innerHTML = `<img src="${d.poster}" alt="Thumbnail" class="rounded-lg" style="max-width: 246px; max-height: 280px; width: auto; height: auto; object-fit: contain;">`;
                            }
                            // Update hidden field for form submission
                            const thumbnailPathEl = document.getElementById('thumbnail_path');
                            if (thumbnailPathEl) {
                                thumbnailPathEl.value = d.poster;
                            }
                        }
                    } catch (_) { }

                    // Release date
                    const rdEl = document.getElementById('release_date');
                    if (rdEl && d.release_date) {
                        rdEl.value = String(d.release_date).slice(0, 10);
                    }

                    // Adult flag
                    const adultEl = document.querySelector('input[name="adult"]');
                    if (adultEl && typeof d.is_adult === 'boolean') {
                        adultEl.checked = !!d.is_adult;
                    }

                    // IMDb rating
                    const val = (parsedData.rating_rounded_1dp != null ? Number(parsedData.rating_rounded_1dp)
                        : (parsedData.rating_rounded != null ? Number(parsedData.rating_rounded)
                            : (parsedData.rating != null ? Math.round(Number(parsedData.rating)) : null)));
                    if (val != null && !Number.isNaN(val)) {
                        imdbInput.value = val;
                    }

                    // Update average rating UI
                    try { if (window.updateAvgRatingUI) window.updateAvgRatingUI(); } catch (_) { }

                    // Show success message (only if showToast is defined)
                    if (typeof showToast === 'function') {
                        showToast('IMDb data successfully imported!', false);
                    }

                    // Clean up sessionStorage
                    sessionStorage.removeItem('imdb_selection_data');
                    sessionStorage.removeItem('imdb_selection_timestamp');
                }
            }
            } catch (error) {
            console.error('Error populating form from sessionStorage:', error);
        }
    }

        // Check for sessionStorage data FIRST (new method takes precedence)
        const hasSessionData = sessionStorage.getItem('imdb_selection_data');
        if (hasSessionData) {
            console.log('[DEBUG] Found sessionStorage data, using it');
            populateFormFromSessionStorage();
        } else {
            // Fallback to URL parameters (legacy support)
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('imdb_success') === 'true') {
                console.log('[DEBUG] No sessionStorage, using URL params (legacy)');
                // Show success message if returning from selection page (only if showToast is defined)
                if (typeof showToast === 'function') {
                    const successMsg = urlParams.get('message') || 'IMDb data successfully imported';
                    showToast(successMsg, false);
                }

                // Clean up URL parameters
                const cleanUrl = window.location.pathname;
                window.history.replaceState({}, document.title, cleanUrl);
            }
        }

    // Dropdown add-genre handler
    const genreSelect = document.getElementById('genre_add_select');
    if (genreSelect) {
        genreSelect.addEventListener('change', function () {
            const val = genreSelect.value;
            if (!val) return;
            const cur = parseGenres(genresHiddenInput.value || '');
            cur.push(val);
            setGenresArray(cur);
            genreSelect.selectedIndex = 0; // reset to "Add Genre"
        });
    }
    });
</script>
<script>
    // AJAX submit to keep page and show auto-dismiss popup
    document.addEventListener('DOMContentLoaded', function () {
        const form = document.getElementById('mediaEditForm');
        if (!form) return;

        function updateAvgRatingUI() {
            try {
                const imdbEl = document.getElementById('imdb_rating');
                const userEl = document.getElementById('user_score');
                const avgEl = document.getElementById('avg_rating');
                if (!avgEl) return;

                const vals = [];

                // Get IMDB rating value
                if (imdbEl && imdbEl.value && imdbEl.value.trim() !== '') {
                    const imdbVal = parseFloat(imdbEl.value);
                    if (!isNaN(imdbVal) && imdbVal > 0) {
                        vals.push(imdbVal);
                    }
                }

                // Get user score value
                if (userEl && userEl.value && userEl.value.trim() !== '') {
                    const userVal = parseFloat(userEl.value);
                    if (!isNaN(userVal) && userVal > 0) {
                        vals.push(userVal);
                    }
                }

                // Calculate and set average
                if (vals.length > 0) {
                    const sum = vals.reduce((a, b) => a + b, 0);
                    avgEl.value = Math.round(sum / vals.length);
                } else {
                    avgEl.value = '';
                }
            } catch (_) { /* no-op */ }
        }
        window.updateAvgRatingUI = updateAvgRatingUI;

        // Set up event listeners
        const userScoreEl = document.getElementById('user_score');
        if (userScoreEl) userScoreEl.addEventListener('input', updateAvgRatingUI);

        // Initialize on page load
        updateAvgRatingUI();

        function showToast(message, isError) {
            const toast = document.createElement('div');
            toast.textContent = message || 'Item saved.';
            toast.style.position = 'fixed';
            toast.style.top = '16px';
            toast.style.right = '16px';
            toast.style.zIndex = '9999';
            toast.style.padding = '12px 16px';
            toast.style.borderRadius = '8px';
            toast.style.boxShadow = '0 2px 10px rgba(0,0,0,0.2)';
            toast.style.color = isError ? '#fff' : '#0f5132';
            toast.style.background = isError ? '#dc3545' : '#d1e7dd';
            toast.style.border = isError ? '1px solid #b02a37' : '1px solid #badbcc';
            toast.style.opacity = '0';
            toast.style.transition = 'opacity 150ms ease';
            document.body.appendChild(toast);
            requestAnimationFrame(() => { toast.style.opacity = '1'; });
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 5000);
        }

        form.addEventListener('submit', async function (e) {
            e.preventDefault();
            const submitBtn = form.querySelector('button[type="submit"]');
            if (submitBtn) submitBtn.disabled = true;
            try {
                const res = await fetch(form.action, {
                    method: 'POST',
                    headers: { 'X-Requested-With': 'XMLHttpRequest' },
                    body: new FormData(form)
                });
                let data = null;
                try { data = await res.json(); } catch (_) { }
                if (!res.ok || !data || data.success !== true) {
                    throw new Error((data && data.error) || ('HTTP ' + res.status));
                }
                showToast(data.message || 'Item saved.');
                try { if (window.updateAvgRatingUI) window.updateAvgRatingUI(); } catch (_) { }
            } catch (err) {
                console.error('[DEBUG] Save error:', err);
                console.error('[DEBUG] Error message:', err.message);
                console.error('[DEBUG] Error stack:', err.stack);
                showToast('Save failed: ' + err.message, true);
            } finally {
                if (submitBtn) submitBtn.disabled = false;
            }
        });
    });
</script>
{% endblock %}